apiVersion: v1
kind: ConfigMap
metadata:
  name: coturn-config
  namespace: stash-example
data:
  turnserver.conf: |
    # Coturn TURN server configuration

    # Listening port for TURN
    listening-port=3478
    tls-listening-port=5349

    # External IP (DigitalOcean LoadBalancer IP)
    external-ip=209.38.172.46

    # Relay IP (use pod IP)
    relay-ip=0.0.0.0

    # Listening IP
    listening-ip=0.0.0.0

    # Realm for authentication
    realm=stash.scalebase.io

    # Server name
    server-name=turn.stash.scalebase.io

    # Use fingerprints in TURN messages
    fingerprint

    # Use long-term credentials
    lt-cred-mech

    # Static users (username:password)
    # For production, use DATABASE or REDIS for dynamic users
    user=stash:stashTurn2024!

    # Quotas
    max-bps=1000000
    bps-capacity=0
    stale-nonce=600

    # Logs
    log-file=stdout
    verbose

    # Enable prometheus metrics (optional)
    prometheus

    # Deny specific peer IPs (security)
    no-multicast-peers
    no-loopback-peers

    # Allow TCP relay for better NAT traversal
    # no-tcp-relay (REMOVED - we need TCP relay!)

    # Security
    no-cli
    no-tlsv1
    no-tlsv1_1

    # Channel lifetime
    channel-lifetime=600
    permission-lifetime=300

    # Total quota
    total-quota=100
    user-quota=10
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: coturn
  namespace: stash-example
  labels:
    app: coturn
spec:
  replicas: 1
  selector:
    matchLabels:
      app: coturn
  template:
    metadata:
      labels:
        app: coturn
    spec:
      containers:
      - name: coturn
        image: coturn/coturn:4.6.2-alpine
        imagePullPolicy: IfNotPresent
        ports:
        - containerPort: 3478
          protocol: UDP
          name: turn-udp
        - containerPort: 3478
          protocol: TCP
          name: turn-tcp
        - containerPort: 5349
          protocol: TCP
          name: turns-tcp
        - containerPort: 5349
          protocol: UDP
          name: turns-udp
        # Port range for relay
        - containerPort: 49152
          protocol: UDP
          name: relay-start
        - containerPort: 65535
          protocol: UDP
          name: relay-end
        env:
        - name: EXTERNAL_IP
          value: "209.38.172.46"
        - name: TURN_USERNAME
          value: "stash"
        - name: TURN_PASSWORD
          value: "stashTurn2024!"
        volumeMounts:
        - name: coturn-config
          mountPath: /etc/coturn
          readOnly: true
        resources:
          requests:
            memory: "128Mi"
            cpu: "100m"
          limits:
            memory: "512Mi"
            cpu: "500m"
        livenessProbe:
          tcpSocket:
            port: 3478
          initialDelaySeconds: 10
          periodSeconds: 10
        readinessProbe:
          tcpSocket:
            port: 3478
          initialDelaySeconds: 5
          periodSeconds: 5
      volumes:
      - name: coturn-config
        configMap:
          name: coturn-config
---
apiVersion: v1
kind: Service
metadata:
  name: coturn-service
  namespace: stash-example
  labels:
    app: coturn
spec:
  type: LoadBalancer
  selector:
    app: coturn
  ports:
  # TURN/STUN UDP
  - port: 3478
    targetPort: 3478
    protocol: UDP
    name: turn-udp
  # TURN/STUN TCP
  - port: 3478
    targetPort: 3478
    protocol: TCP
    name: turn-tcp
  # TURNS (TLS) TCP
  - port: 5349
    targetPort: 5349
    protocol: TCP
    name: turns-tcp
  # TURNS (TLS) UDP
  - port: 5349
    targetPort: 5349
    protocol: UDP
    name: turns-udp
  sessionAffinity: ClientIP
  sessionAffinityConfig:
    clientIP:
      timeoutSeconds: 10800
